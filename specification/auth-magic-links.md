# Спецификация авторизации по магической ссылке и управления пользователями

## Назначение

Цель — упростить вход для обычных пользователей и одновременно сохранить полный контроль для администратора.

Механизм:
- **Базовый вход для пользователей** — по магической ссылке (без знания пароля).
- **Админский вход** — по паролю через отдельный роут; админ знает пароли учётных записей и может логиниться под любым пользователем для проверки.
- **Админская страница пользователей** — управление пользователями (список, создание, редактирование ролей и паролей, удаление с подтверждением).

Существующая система авторизации (сессии, роли, таблица `users`) должна быть сохранена и расширена, а не переписана с нуля.

---

## Переменные окружения

### База

Используются уже существующие переменные, плюс новые для email и magic link.

#### Auth / сессии (уже есть)
- `ADMIN_USER` — email первоначального админа (используется при инициализации БД).
- `ADMIN_PASS` — пароль первоначального админа (однократное использование для первичного создания записи; далее может быть изменён через админку).
- `SESSION_SECRET` — секрет для сессий (`@fastify/session`).

> Примечание: после внедрения страницы управления пользователями администратор сможет изменить пароль своей учётной записи в UI, но переменная `ADMIN_PASS` остаётся источником **первоначального** пароля.

#### Email-настройки (новые)

Добавляются переменные для SMTP, в соответствии с пожеланиями:

| Переменная          | Описание                                                | Пример                     |
|---------------------|---------------------------------------------------------|----------------------------|
| `EMAIL_HOST`        | SMTP хост                                               | `smtp.example.com`         |
| `EMAIL_PORT`        | SMTP порт                                               | `587`                      |
| `EMAIL_USER`        | Логин SMTP                                             | `no-reply@example.com`     |
| `EMAIL_PASSWORD`    | Пароль SMTP                                            | `super-secret`             |
| `EMAIL_USE_TLS`     | Включить TLS (`true`/`false`)                          | `true`                     |
| `EMAIL_FROM_NAME`   | Имя отправителя в письмах                              | `Square Publisher`         |
| `EMAIL_RATE_LIMIT`  | Максимум исходящих писем в минуту (глобальный лимит)   | `60`                       |
| `EMAIL_TIMEOUT`     | Таймаут SMTP-соединения в секундах                     | `10`                       |

Конфиг читается в `config/index.js` в новый раздел `email`.

#### Magic link

Дополнительно (опционально, можно задать значения по умолчанию в коде):

| Переменная                | Описание                                               | По умолчанию |
|---------------------------|--------------------------------------------------------|--------------|
| `MAGIC_LINK_TTL_MINUTES`  | Время жизни токена в минутах                          | `60`         |
| `MAGIC_LINK_MAX_PER_HOUR` | Макс. число активных токенов на пользователя в час    | `10`         |
| `MAGIC_LINK_RATE_LIMIT`   | Макс. число запросов магссылки на email в час         | `20`         |

---

## Данные и миграции

### Таблица `users` (существующая)

Используем текущую структуру (упрощённо):
- `id` INTEGER PRIMARY KEY
- `email` TEXT UNIQUE NOT NULL
- `password_hash` TEXT NOT NULL
- `role` TEXT NOT NULL CHECK(role IN ('admin','editor'))
- `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP
- `last_login_at` DATETIME NULL

Требования:
- Админ может изменять `password_hash` (через форму смены пароля).
- Для новых пользователей пароль задаётся админом, но пользователь его может не знать (использует только magic link).

### Новая таблица `magic_links`

Добавляется новая миграция `XXX_create_magic_links.sql` в `db/migrations/`.

Предлагаемая структура:

- `id` INTEGER PRIMARY KEY
- `user_id` INTEGER NOT NULL REFERENCES `users`(`id`) ON DELETE CASCADE
- `token` TEXT NOT NULL UNIQUE
- `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
- `expires_at` DATETIME NOT NULL
- `used_at` DATETIME NULL
- `ip_created` TEXT NULL — IP, с которого был запрошен токен
- `user_agent` TEXT NULL — user-agent при создании (для аудита / возможной отладки)

Индексы:
- INDEX по `user_id`
- INDEX по `token`
- Опционально: индекс по `expires_at` для очистки истёкших токенов (в будущих задачах по фоновому housekeeping).

Семантика:
- Токен **считается валидным**, если:
  - существует запись в `magic_links` с данным `token`;
  - `used_at IS NULL`;
  - `datetime('now') <= expires_at`.
- После успешного логина `used_at` заполняется.
- Если ссылка просрочена или уже использована — логин не происходит, показывается сообщение об ошибке и предложение запросить новую ссылку.

### Хранение паролей

Пароли продолжают храниться только в виде `bcrypt`-хэша в `users.password_hash`.

Изменения:
- В `lib/users.js` добавляются функции для:
  - обновления пароля пользователя (по id);
  - (опционально) проверки, что новый пароль не пустой и удовлетворяет минимальным требованиям (минимальная длина, базовая валидация).

---

## Функциональные сценарии

### 1. Базовый вход по магической ссылке (для всех ролей)

**Роуты:**
- `GET /login` — форма запроса магической ссылки.
- `POST /login/magic` — обработка запроса: создать токен, отправить письмо.
- `GET /login/magic/:token` — переход по ссылке, валидация токена, авторизация.

#### 1.1. Форма `GET /login`

Назначение: простой вход для пользователя без знания пароля.

UI (новый шаблон, например `views/admin/magic-login.ejs` или общий login-шаблон с табами):
- Поле ввода `email` (обязательное).
- Кнопка `Send magic link`.
- Текст-пояснение, что на указанную почту придёт ссылка для входа.

Требования:
- Если пользователь уже авторизован (есть `session.userId`) — редирект на `/admin/posts` (или другую стартовую страницу админки).

#### 1.2. Обработка `POST /login/magic`

Алгоритм:
1. Прочитать `email` из `request.body`.
2. Если `email` пустой — вернуть ту же форму с сообщением об ошибке.
3. Найти пользователя по `email` в таблице `users`:
   - Если пользователь **не найден** — **поведение в UI**: всегда показывать одинаковое сообщение вида «Если такой email существует, мы отправили на него ссылку» (не раскрывать существование учётной записи).
   - При этом **фактически** токен не создаётся и письмо не отправляется.
4. Если пользователь найден:
   - Проверить rate-limit по email (и, опционально, по IP):
     - Считать число запросов/созданных токенов за последний час по `user_id` и/или `email`.
     - Если превышен `MAGIC_LINK_RATE_LIMIT` или `MAGIC_LINK_MAX_PER_HOUR` — не создавать токен, не отправлять письмо, но в UI всё равно показать стандартное сообщение без деталей.
   - Если лимит не превышен:
     - Сгенерировать криптографически стойкий токен (например, `crypto.randomBytes(32).toString('hex')`).
     - Вычислить `expires_at = now + MAGIC_LINK_TTL_MINUTES`.
     - Записать в `magic_links` строку с `user_id`, `token`, `expires_at`, `ip_created`, `user_agent`.
     - Сформировать URL: `${BASE_URL}/login/magic/${token}`.
     - Отправить email (через `nodemailer` или аналогичный модуль), используя настройки `EMAIL_*`.
5. В ответ вернуть страницу с сообщением: «Если такой email существует, мы отправили на него ссылку для входа».

#### 1.3. Переход по ссылке `GET /login/magic/:token`

Алгоритм:
1. Прочитать `token` из `params`.
2. Найти запись в `magic_links` по `token`.
3. Проверить:
   - запись существует;
   - `used_at IS NULL`;
   - `expires_at >= now`.
4. Если что-либо из проверок не прошло:
   - Показать страницу с сообщением: «Ссылка недействительна или устарела. Пожалуйста, запросите новую ссылку для входа.»
   - Код ответа: 400 или 410 (по решению, но с точки зрения UX без технических подробностей).
5. Если токен валиден:
   - Найти пользователя по `user_id`.
   - Если пользователь не найден (крайний случай) — показать ошибку и логировать как аномалию.
   - Установить в сессии:
     - `session.userId = user.id`
     - `session.email = user.email`
     - `session.role = user.role`
   - Обновить `users.last_login_at = now`.
   - Обновить запись `magic_links.used_at = now` (делает токен одноразовым).
   - Логировать успешный вход как отдельное событие в `lib/audit.js` (например, `magic_login_success`).
   - Редирект на `/admin/posts` (или главную страницу админки).

Дополнительно:
- При желании можно разрешить повторное использование токена **до истечения срока**, но спецификация фиксирует **одноразовый** подход для безопасности.

### 2. Админский вход по паролю

Существующая механика сохраняется:
- `GET /admin/login` — форма логина по паролю.
- `POST /admin/login` — обработка логина (через `verifyUser` в `lib/users.js`).

Требования:
- Админ может входить как под своей учётной записью, так и под любой другой (зная email и пароль этой учётной записи).
- Пароли для остальных пользователей задаются и меняются только через админку (страница управления пользователями).

### 3. Страница управления пользователями в админке

**Новая страница**, доступная только для ролей `admin`.

Предлагаемый URL:
- `GET /admin/users` — список пользователей.
- `GET /admin/users/new` — форма создания пользователя.
- `POST /admin/users` — создание пользователя.
- `GET /admin/users/:id/edit` — форма редактирования пользователя.
- `POST /admin/users/:id` — сохранение изменений пользователя.
- `POST /admin/users/:id/delete` — удаление пользователя (с подтверждением через модальное окно в UI).

#### 3.1. Список пользователей `GET /admin/users`

UI (новый шаблон, например `views/admin/users.ejs`):
- Заголовок `Users`.
- Таблица со столбцами:
  - Email
  - Role
  - Created at
  - Last login at
  - Действия (Edit, Delete)
- Кнопка `New User` рядом с заголовком таблицы.

Требования:
- Страница защищена через `require-auth` и проверку роли `admin`.

#### 3.2. Создание пользователя `GET /admin/users/new`, `POST /admin/users`

Форма полей:
- `email` (обязательное, уникальное).
- `role` (`admin` или `editor`).
- `password` (необязательное, но если пустое — нужно предупредить админа или не разрешать сохранение без пароля; в рамках этой спецификации — **делаем пароль обязательным при создании**).

Алгоритм `POST /admin/users`:
1. Валидация полей (email корректный, роль допустимая, пароль не пустой и достаточно длинный).
2. Проверка уникальности email.
3. Создание пользователя через `createUser(email, password, role)` из `lib/users.js`.
4. Логирование события (например, `user_created`) через `lib/audit.js`.
5. Редирект на `/admin/users` с флеш-сообщением об успехе.

#### 3.3. Редактирование пользователя `GET /admin/users/:id/edit`, `POST /admin/users/:id`

Форма полей:
- `email` (может быть неизменяемым или изменяемым — уточнить в реализации, по умолчанию разрешить).
- `role` (admin/editor).
- `password` (опциональное поле **New password**):
  - если оставлено пустым — пароль не меняется;
  - если не пусто — пароль хэшируется и обновляется.

Алгоритм обновления `POST /admin/users/:id`:
1. Получить пользователя по `id`.
2. Обновить email и role (если разрешено изменять email) с валидацией и проверкой уникальности.
3. Если `password` не пуст — обновить `password_hash`.
4. Логировать действие (например, `user_updated`).
5. Редирект на `/admin/users`.

#### 3.4. Удаление пользователя `POST /admin/users/:id/delete`

UI:
- В таблице пользователей кнопка `Delete`.
- При клике открывается модальное окно подтверждения:
  - Текст: «Вы действительно хотите удалить пользователя <email>? Это действие нельзя отменить.»
  - Кнопки `Cancel` и `Delete`.

Алгоритм:
1. Проверить, что администратор не удаляет сам себя **(опционально, но рекомендуется)**.
2. Удалить пользователя и связанные `magic_links` (через ON DELETE CASCADE или вручную).
3. Логировать событие `user_deleted`.
4. Редирект на `/admin/users`.

---

## Email-рассылка магических ссылок

### Модуль отправки email

Новый модуль, например `lib/email.js`:
- Читает настройки из `config.email`.
- Инициализирует `nodemailer` транспорт.
- Предоставляет функцию:
  - `sendMagicLinkEmail({ to, link, expiresInMinutes })` — отправка письма с магической ссылкой.

Шаблон письма (минимально):
- Тема: `Your login link`
- Тело (HTML + текст):
  - Краткое объяснение (вы запросили ссылку для входа).
  - Сама ссылка `link`.
  - Указание срока действия (например, 60 минут).

### Rate limiting на уровне email

- Использовать значения `EMAIL_RATE_LIMIT` и/или `MAGIC_LINK_RATE_LIMIT` для ограничения числа писем:
  - На уровне пользователя (по `user_id` / `email`).
  - Опционально на уровне IP.
- При превышении лимита email **фактически** не отправляется, но в UI всегда одинаковое сообщение.

---

## Безопасность и аудит

- Все операции логина (по паролю и через magic link) должны логироваться в `lib/audit.js` с типами событий, например:
  - `login_success`
  - `login_failed`
  - `magic_login_success`
  - `magic_login_failed`
- Токены должны быть достаточно длинными и случайными (минимум 32 байта случайных данных).
- Токен никогда не логируется целиком (можно логировать только первые 6–8 символов для трейсабельности).
- Ссылки в письме должны использовать `config.server.baseUrl`.
- В случае ошибок отправки email:
  - Логировать ошибку на сервере.
  - В UI всё равно показывать нейтральное сообщение.

---

## План реализации

1. **Миграция БД**
   - Добавить файл миграции `XXX_create_magic_links.sql` в `db/migrations/`.
   - Прогнать `npm run migrate`.

2. **Обновление конфига**
   - В `config/index.js` добавить секцию `email` и (при необходимости) секцию `magicLink`, читающую `EMAIL_*` и `MAGIC_LINK_*`.

3. **Модуль email**
   - Создать `lib/email.js` с интеграцией `nodemailer` и функцией `sendMagicLinkEmail`.

4. **Модуль magic link**
   - Создать `lib/magicLinks.js` с функциями:
     - создания токена;
     - поиска токена; 
     - валидации и пометки `used_at`.

5. **Маршруты авторизации**
   - Расширить/создать роутер (например, `routes/admin/auth.js` или отдельный файл):
     - `GET /login` — форма запроса email.
     - `POST /login/magic` — запрос на создание токена и отправку письма.
     - `GET /login/magic/:token` — обработка входа.

6. **Шаблоны UI**
   - Создать/расширить EJS-шаблоны:
     - Форма `GET /login`.
     - Страница/сообщения успешного запроса и ошибки недействительной ссылки.

7. **Страница пользователей в админке**
   - Новый роутер, например `routes/admin/users.js`.
   - Новые шаблоны `views/admin/users.ejs`, `views/admin/user-form.ejs`.
   - Логика create/edit/delete.

8. **Обновление README и .env.example**
   - Описать новые переменные окружения `EMAIL_*` и `MAGIC_LINK_*`.
   - Добавить раздел о логине по магической ссылке.

9. **Тестирование (ручное)**
   - См. раздел ниже.

---

## Ожидаемые результаты и критерии готовности

### Функциональные критерии

1. **Вход по магической ссылке**
   - Пользователь с существующим `email` может запросить ссылку на `/login` и успешно войти по ссылке.
   - Пользователь с несуществующим `email` видит то же сообщение, но письмо не отправляется.
   - Просроченная или использованная ссылка больше не логинит и показывает понятное сообщение.

2. **Админский вход**
   - Админ всё так же может войти на `/admin/login` по паролю.
   - Админ может сменить свой пароль через страницу редактирования пользователя.

3. **Управление пользователями**
   - Страница `/admin/users` показывает список пользователей.
   - Можно создать нового пользователя с email, ролью и паролем.
   - Можно изменить роль и (при необходимости) пароль пользователя.
   - Можно удалить пользователя (с подтверждением через модальное окно).

4. **Отправка email**
   - При корректных SMTP-настройках письма с магическими ссылками реально уходят на указанный email.
   - При проблемах с SMTP сервер логирует ошибку, UI не раскрывает технических деталей.

### Нефункциональные критерии

1. **Безопасность**
   - Все токены одноразовые и имеют ограниченный срок жизни (по умолчанию 60 минут).
   - Токены не логируются в явном виде.
   - Нет разницы в ответах UI между существующим и несуществующим email.

2. **Надёжность**
   - При недоступности SMTP сервер не падает, а корректно обрабатывает ошибку.
   - Ошибка при создании токена или логина не раскрывает лишних деталей пользователю.

3. **Поддерживаемость**
   - Логика работы с magic links изолирована в отдельном модуле.
   - Отправка email изолирована в `lib/email.js`.
   - Спецификация (этот файл) отражает реализованное поведение.

---

## Ручное тестирование

1. **Позитивный сценарий магической ссылки**
   1.1. Создать пользователя-редактора через `/admin/users`.
   1.2. Перейти на `/login`, ввести его email.
   1.3. Убедиться, что письмо получено, кликнуть по ссылке.
   1.4. Проверить, что пользователь попадает в админку и в БД обновилось `last_login_at`, `magic_links.used_at`.

2. **Неверный email**
   2.1. На `/login` ввести email, которого нет в БД.
   2.2. Убедиться, что письмо не отправлено (по логам SMTP), но UI даёт то же сообщение.

3. **Просроченный токен**
   3.1. Изменить `MAGIC_LINK_TTL_MINUTES` на 1 минуту (для теста).
   3.2. Запросить ссылку, подождать истечения TTL.
   3.3. Кликнуть по ссылке — получить сообщение об устаревшей ссылке.

4. **Повторное использование токена**
   4.1. Войти по ссылке один раз (успешно).
   4.2. Повторно открыть ссылку в другом браузере/окне.
   4.3. Убедиться, что вход не происходит и показывается сообщение об ошибке.

5. **Админ меняет пароль пользователя**
   5.1. В `/admin/users/:id/edit` задать новый пароль пользователю.
   5.2. Выйти из админки.
   5.3. Попробовать войти под этим пользователем через `/admin/login` (email + новый пароль).

6. **Удаление пользователя**
   6.1. Удалить пользователя через `/admin/users`.
   6.2. Убедиться, что его больше нет в списке и что его токены в `magic_links` больше не работают.

Этот документ служит основой для реализации и проверки механизма авторизации по магической ссылке и управления пользователями в админке.
